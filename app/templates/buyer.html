{% extends "base.html" %}

{% block styles%}
	<style>
		.ec-radiogroup, .ec-cart__next, .ec-form--comments, .ec-header-h5 {display:none;}
	</style>
{% endblock %}

{% block content %}
	<div class="container">
		<div id="my-store-{{current_user.hub.store_id}}"></div>
	</div>
	
	<div class="modal fade" id="siteLocationModal" tabindex="-1" role="dialog" aria-labelledby="siteLocationModalLabel" aria-hidden="true">
		<div class="modal-dialog" role="document">
			<div class="modal-content">
				<div class="modal-header">
					<h5 class="modal-title" id="siteLocationModalLabel">Площадка и объект</h5>
				</div>
				<div class="modal-body">
					<div class="row my-1">
						<div class="col">
							<select class="form-control border-danger" id="locationSelect">
								<option value="" disabled selected>Выберите площадку...</option>
								{% for location in locations %}
									<option>{{ location.name }}</option>
								{% endfor %}
							</select>
						</div>
					</div>
					<div class="row my-1">
						<div class="col">
							<select class="form-control border-danger" id="siteSelect">
								<option value="" disabled selected>Выберите объект...</option>
							</select>
						</div>
					</div>
				</div>
				<div class="modal-footer">
					<button type="button" class="btn btn-secondary" data-dismiss="modal" disabled id="siteLocationDismiss">Продолжить</button>
				</div>
			</div>
		</div>
	</div>
{% endblock %}
{% block scripts %}
<script data-cfasync="false" type="text/javascript" src="https://app.shopsettings.com/script.js?{{current_user.hub.store_id}}&data_platform=code&data_date=2020-10-28" charset="utf-8"></script>
<script>
	xProductBrowser("categoriesPerRow=3","views=grid(20,3) list(60) table(60)","categoryView=grid","searchView=list","id=my-store-{{current_user.hub.store_id}}");
	$(document).ready(function(){
	
		$("#siteLocationModal").modal({'backdrop':'static'});
		
		var locations = [
					{% for location in locations %}
						{{ location|safe }},
					{% endfor %}
						];
		
		Ecwid.OnAPILoaded.add(function() {
			Ecwid.Cart.setCustomerEmail("{{ current_user.email }}");
			
			$("#locationSelect").change(function(){
				ec.order = ec.order || {};
				let val = $(this).val();
				ec.order.referer_id = val;
				$(this).removeClass("border-danger");
				$("#siteLocationDismiss").prop("disabled", true);
				let sitesList = $("#siteSelect");
				sitesList.empty();
				let defaultSite = $("<option>").text("Выберите объект...");
				defaultSite.prop("disabled", true);
				defaultSite.prop("selected", true);
				sitesList.append(defaultSite);
				
				for(let i = 0; i < locations.length; i++) {
					loc = locations[i];
					if (loc["name"].toUpperCase() === val.toUpperCase()){
						for (j = 0; j < loc["sites"].length; j++)
						{
							sitesList.append($("<option>").text(loc["sites"][j]["name"]));
						}
						break;
					}
				}
				
			});
			$("#siteSelect").change(function(){
				let val = $(this).val();
				Ecwid.Cart.setOrderComments(JSON.stringify({'object':val, 'comment':'', 'budget':'', 'cashflow':''}));
				$(this).removeClass("border-danger");
				$("#siteLocationDismiss").prop("disabled", false);
			});
		});
		
	});
</script>
{%endblock %}