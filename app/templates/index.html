{% extends "base.html" %}

{% block styles %}
	<style>
		.ecwidOrder{
			cursor: pointer;
		}
	</style>
{% endblock %}

{% block content %}
<div class="container my-2">
	<div class="row justify-content-center">
		<div class="col-md-8">
			<input class="form-control" id="orderFilter" type="text" placeholder="Фильтр..">
		</div>
	</div>
	<div class="row justify-content-center">
		<div class="col-md-8">
			{% for d in dates %}
				<a href="{{ url_for('main.ShowIndex', from = dates[d], focus=filter_focus) }}" class="text-decoration-none badge {%if filter_from == dates[d] %}bg-primary{%else%}bg-secondary{%endif%}">{{ d }}</a>
			{% endfor %}
			<a href="{{ url_for('main.ShowIndex', from = 0, focus=filter_focus) }}" class="text-decoration-none badge {%if filter_from == 0 %}bg-primary{%else%}bg-secondary{%endif%}">все</a>
		</div>
	</div>
</div>
<div class="container">
	<div class="row my-2">
		<div class="col">
			Показано <span id="orderCount">{{ orders|length }}</span> заявок
			{% if current_user.role.name in ['validator', 'purchaser'] %}
				<br>
				<div class="form-check form-check-inline">
					<input class="form-check-input" type="checkbox" id="filterFocus" {%if not filter_focus%}checked{%endif%}>
					<label class="form-check-label" for="filterFocus">Показывать только заявки, которые я должен согласовать.</label>
				</div>
			{% endif %}
		</div>
		<div class="col text-end">
			<a href="#" id="saveOrdersButton">скачать</a><br>
			{% if current_user.role.name in ['admin', 'initiative', 'purchaser'] %}			
				<a href="#" id="startMerging">объединить</a>
			{% endif %}				
		</div>

	</div>
	<div class="row bg-light d-none d-sm-flex border">
		<div class="col-2 overflow-hidden">
			Заявка
		</div>
		<div class="col overflow-hidden">
			Инициатор
		</div>
		<div class="col overflow-hidden">
			Согласен
		</div>
		<div class="col overflow-hidden">
			Не&nbsp;согласен
		</div>
		<div class="col overflow-hidden">
			Ожидаем
		</div>
		<div class="col-2 overflow-hidden">
			Статус
		</div>
	</div>
	{% for order in orders %}
		{% include '_order.html' %}
	{% endfor %}
</div>


{% if current_user.role.name in ['admin', 'initiative', 'purchaser'] %}
	<form id="mergeForm" class="d-none" method="POST" action="{{ url_for('main.MergeOrders') }}">
		<div class="fixed-top">
			<div class="container">
				<div class="row">
					<div class="col">
						<button id="cancelMerging" type="button" class="btn btn-danger">Отменить</button>
					</div>
					<div class="col text-end">
						{{ merge_form.csrf_token(id=False) }}
						{{ merge_form.orders(id='mergeOrders', class_='d-none', readonly=True) }}
						{{ merge_form.submit(id=False, class_ = 'btn btn-primary') }}
					</div>
				</div>
			</div>
		</div>
	</form>
{% endif %}

<form id="saveForm" class="d-none" method="POST" action="{{ url_for('main.SaveOrders') }}">
	{{ save_form.csrf_token(id=False) }}
	{{ save_form.orders(id="saveOrders", class_="d-none") }}
</form>

{% endblock %}

{% block scripts %}

<script>
	$(document).ready(function(){
	
		var isMerging = false;
		
		
		$("#filterFocus").change(function(){
			if (this.checked)
				document.location.href = "{{ url_for('main.ShowIndex', from = filter_from) }}".replaceAll("&amp;", "&");
			else
				document.location.href = "{{ url_for('main.ShowIndex', from = filter_from, focus=True) }}".replaceAll("&amp;", "&");
		});
		
		$("#saveOrdersButton").click(function(){
			$("#saveForm").submit()
		});

	{% if current_user.role.name in ['admin', 'initiative', 'purchaser'] %}
	
		var mergeOrders = [];

		$("#startMerging").click(function(){
			isMerging = true;
			mergeOrders = [];
			$("#mergeForm").removeClass("d-none");
			$(this).hide();
		});
		
		$("#cancelMerging").click(function(){
			isMerging = false;
			$("#mergeForm").addClass("d-none");
			$("#startMerging").show();
			$(".ecwidOrder.bg-dark.text-white").removeClass("bg-dark text-white");
			$(".ecwidOrder").addClass("bg-white");
		});
	
	{% endif %}
	
		$("#orderFilter").on("keyup", function() {
			let value = $(this).val().toLowerCase();
			let order_list = [];
			$(".ecwidOrder").filter(function() {
				let show = $(this).text().toLowerCase().indexOf(value) > -1;
				$(this).toggle(show);
				if (show){
					order_list.push($(this).data("id"));
				}
			});
			$("#orderCount").text(order_list.length);
			$("#saveOrders").val(JSON.stringify(order_list));
		});
		
		$(".ecwidOrder").click(function(event){
			let orderId = $(this).attr('data-id');
			if (isMerging == false){
				document.location.href = "{{ url_for('main.ShowOrder', order_id = 'replace_me') }}".replace("replace_me", orderId);
			}else{
				if (mergeOrders.includes(orderId)){
					$(this).removeClass("bg-dark text-white");
					$(this).addClass("bg-white");
					let index = mergeOrders.indexOf(orderId);
					mergeOrders.splice(index, 1);
				} else {
					mergeOrders.push(orderId);
					$(this).removeClass("bg-white");
					$(this).addClass("bg-dark text-white");
				}
				console.log(JSON.stringify(mergeOrders));
				$("#mergeOrders").val(JSON.stringify(mergeOrders));
			}
		});
	});
</script>
{%endblock %}