{% extends "base.html" %}

{% block styles %}
<style>
/*switch on-off */
.toggle-label {
  position: relative;
  width: 200px;
  height: 30px;
  margin-top: 10px;
}
.toggle-label input[type=checkbox] { 
    opacity: 0;
    position: absolute;
    width: 100%;
    height: 100%;
    left: 0;
    top: 0;
}
.toggle-label input[type=checkbox]+.back {
    position: absolute;
    width: 100%;
    height: 30px;
    left: 0;
    top: 0;
    border-radius: 50px;
    border: 1px solid #000;
    transition: background 150ms linear;
	background: #6c757d;
}
.toggle-label input[type=checkbox]:checked+.back {
    border: 1px solid #000;
    cursor: pointer;
}

.toggle-label input[type=checkbox]+.back .toggle {
  display: block;
  position: absolute;
  content: ' ';
  background: #28a745;
  width: 50%; 
  height: 100%;
  transition: margin 150ms linear,  background 150ms linear;
  border: 1px solid #808080;
  border-radius: 50px;
}
.toggle-label input[type=checkbox]:checked+.back .toggle {
  margin-left: 100px;
  background: #dc3545;
}
.toggle-label .label {
  display: block;
  position: absolute;
  width: 50%;
  color: #fff;
  line-height: 24px;
  text-align: center;
  font-size: 14px;
}
.toggle-label .label.on { left: 0px; }
.toggle-label .label.off { right: 0px; }

.toggle-label input[type=checkbox]:checked+.back .label.on {
  color: #fff;
}
.toggle-label input[type=checkbox]+.back .label.off {
  color: #fff;
  cursor: pointer;
}
.toggle-label input[type=checkbox]:checked+.back .label.off {
  color: #fff;
}


</style>
{% endblock%}

{% block content %}
	<div class="container">
		{% if current_user in order['reviewers'] %}
			<form action="{{ url_for('main.SaveApproval', order_id = order['orderNumber']) }}" method="POST">
				<div class="row">
					<div class="col-5">
						<span class="font-weight-bold">ЗАЯВКА</span>
						{{ approval_form.csrf_token }}
						#{{ order['vendorOrderNumber'] }}
						от {{ moment(order['createDate']).format() }}
					</div>
					<div class="col text-right">
						<label class="toggle-label">
							<input type="checkbox" {% if not order['reviewers'][current_user]|select|list|first  %}checked{% endif %} onChange="this.form.submit()">
							<span class="back">
								<span class="toggle"></span>
								<span class="label on">согласен</span>
								<span class="label off">НЕ согласен</span>
							</span>
						</label>
					</div>
				</div>
			</form>
		{% else %}
			<div class="row my-2">
				<div class="col">
					<span class="font-weight-bold">ЗАЯВКА</span>
					#{{ order['vendorOrderNumber'] }}
					от {{ moment(order['createDate']).format() }}
					{% if current_user.role.name == 'initiative' %}
						<a class="badge badge-danger" href="{{ url_for('main.DeleteOrder', order_id = order['orderNumber']) }}" onclick="return confirm('Удалить заявку?')">&times;</a>
					{% endif %}
				</div>
			</div>
		{% endif %}
		<div class="row">
			<div class="col">
				<div class="row">
					<div class="col">
						<span class="font-weight-bold">Кем согласована: </span>
						{% for reviewer,status in order['reviewers'].items() %}
							{% if status|length > 0 %}
								{% if status|select|list|first %}
									<span class="font-italic">{{reviewer.name}} {% if reviewer.position %}({{reviewer.position}}){% endif %}</span>,
								{% endif %}
							{% endif %}
						{% endfor %}
					</div>
				</div>
				<div class="row mb-3">
					<div class="col">
						<span class="font-weight-bold">Ждём согласования: </span>
						{% for position,status in order['positions'].items() %}
							{% if not status %}
								<span class="font-italic">"{{ position }}"</span>,
							{% endif %}
						{% endfor %}
					</div>
				</div>
				<div class="row">
					<div class="col">
					{% if current_user.role.name == 'initiative' %}
					<form action="{{ url_for('main.SaveLocation', order_id = order['orderNumber']) }}" id="locationForm" method="POST">
						<span class="font-weight-bold">Площадка: </span>
						{{location_form.csrf_token}}
						{{location_form.location_name() }}
					</form>
					{% else %}
						<span class="font-weight-bold">Площадка: </span>
						{{ order['refererId'] }}
					{% endif %}
					</div>
				</div>
				<div class="row">
					<div class="col">
						<span class="font-weight-bold">Объект: </span>
						{%if order['orderComments']['object']|length == 0%}
							<span class="text-danger">Не указано</span>
						{%else%}
							{{ order['orderComments']['object'] }}
						{%endif%}
					</div>
				</div>	
				<div class="row">
					<div class="col">
						<span class="font-weight-bold">Статья БДР: </span>
						{%if order['orderComments']['budget']|length == 0%}
							<span class="text-danger">Не указано</span>
						{%else%}
							{{ order['orderComments']['budget'] }}
						{%endif%}
					</div>
				</div>	
				<div class="row">
					<div class="col">
						<span class="font-weight-bold">Статья БДДС: </span>
						{%if order['orderComments']['cashflow']|length == 0%}
							<span class="text-danger">Не указано</span>
						{%else%}
							{{ order['orderComments']['cashflow'] }}
						{%endif%}
					</div>
				</div>					
				<div class="row">
					<div class="col">
						<span class="font-weight-bold">Инициатор: </span>
						{{ order['initiative'].name }}
					</div>
				</div>
				<div class="row">
					<div class="col">
						{{ order['initiative'].email }}
					</div>
				</div>
				<div class="row">
					<div class="col">
						{{ order['initiative'].phone }}
					</div>
				</div>
				<div class="row">
					<div class="col">
						<span class="font-weight-bold">Примечание: </span>
						{% if order['orderComments']['comment']|length > 0 %}
							<span class="font-italic">Комментарий инициатора: </span>
							'{{ order['orderComments']['comment'] }}';
						{% endif %}
					</div>	
				</div>
				<div class="row">
					<div class="col">
						<span class="font-weight-bold">Всего позиций: </span>{{ order['items']|length }} на сумму
						<span class="orderTotal">{{ '{:,.2f}'.format(order['total']) }}</span>
					</div>	
				</div>
			</div>
			{% if current_user.role.name not in ['admin','default'] %}
				<div class="col-xs-auto">
					<ul class="nav text-right flex-column bg-light p-2">
						<li class="nav-item">
							Добавить:
						</li>
						<li class="nav-item">
							<a href data-toggle="modal" data-target="#SiteModal" >название объекта</a>
						</li>
						<li class="nav-item">
							<a href data-toggle="modal" data-target="#BECModal" >статья БДР</a>
						</li>
						<li class="nav-item">
							<a href data-toggle="modal" data-target="#CFSModal" >статья БДДС</a>
						</li>
						<li class="nav-item">
							<a href data-toggle="collapse" data-target="#commentFormCollapse" aria-expanded="false" aria-controls="commentFormCollapse">комментарий</a>
						</li>
						<li class="nav-item">
							Отправить:
						</li>
						{% if current_user.role.name == 'initiative' %}
						<li class="nav-item">
							<a href="{{ url_for('main.DuplicateOrder', order_id = order['orderNumber']) }}" onclick="return confirm('Клонировать заявку?')">клонировать</a>
						</li>
						<li class="nav-item">
							<a href="{{ url_for('main.NotifyApprovers', order_id = order['orderNumber']) }}" onclick="return confirm('Отправить уведомление согласующим?')">уведомить</a>
						</li>
						{% elif current_user.role.name == 'approver' %}
						<li class="nav-item">
							<a href="{{ url_for('main.ProcessHubOrder', order_id = order['orderNumber']) }}" {% if order['externalFulfillment'] %}onclick="return confirm('Уже отправлена, отправить ещё раз?')"{% endif %}>поставщику</a>
						</li>
						{% endif %}
						<li class="nav-item">
							<a href="{{ url_for('main.GetExcelReport', order_id = order['orderNumber']) }}">на печать</a>
						</li>
						<li class="nav-item">
							<a href data-toggle="modal" data-target="#report1CModal" >в 1С</a>
						</li>	
					</ul>
				</div>
			{% endif %}
		</div>
	</div>
	<div class="container mt-5">
		<div class="row d-none d-sm-flex font-weight-bold">
			<div class="col overflow-hidden">
				&nbsp;
			</div>		
			<div class="col overflow-hidden">
				Артикул
			</div>		
			<div class="col-3 overflow-hidden">
				Название
			</div>		
			<div class="col overflow-hidden">
				Поставщик
			</div>
			<div class="col overflow-hidden">
				Цена
			</div>
			<div class="col overflow-hidden">
				Кол-во
			</div>
		</div>
		{% for product in order['items'] %}
			{% include '_product.html' %}
		{% endfor %}
	</div>
	
	{% if current_user.role.name not in ['admin','default'] %}
		<div class="container mt-2">
			<div class="collapse" id="commentFormCollapse">
				{% set errorsList = comment_form.comment.errors %}
				{% if errorsList|length > 0 %}
					<div class = "row">
						<div class="col">
							<div class="alert alert-danger" role="alert">
								{% for error in  errorsList %}
									{{ error }}<br>
								{% endfor %}
							</div>
						</div>
					</div>
				{% endif %}
				<form action="{{ url_for('main.SaveComment', order_id = order['orderNumber']) }}" method="post">
					{{ comment_form.csrf_token }}
					<div class="form-group row">
						{{ comment_form.comment.label(class_ = "col-md-2 col-form-label") }}
						<div class="col-md-10">
							{{ comment_form.comment(class_ = 'form-control') }}
							<small class="form-text text-muted">Максимальная длина комментария 256 символов.</small>
						</div>
					</div>
					<div class="form-group row">
						<div class="col">
							{{ comment_form.submit1(class_ = 'btn btn-primary') }}							
						</div>
					</div>
				</form>
			</div>
		</div>
	{% endif %}
	<div class="container">
		<div class="row my-2">
			<div class="col">
				<span class="font-weight-bold">ИСТОРИЯ</span>
			</div>
		</div>
		<div class="row">
			<div class="col">
				<input class="form-control" id="actionsFilter" type="text" placeholder="Фильтр..">
			</div>
		</div>
		<div id="actionsSection">
			{% for event in order['events'] %}	
				<div class="action" data-datetime="{{ event.timestamp.timestamp() }}">
					<div class="row">
						<div class="col">
							<span class="badge badge-{{event.type.color()}}">
								{{ event.user.name }} ({{event.user.position}})
							</span>
							{{ moment(event.timestamp).format() }}
						</div>
					</div>
					<div class="row">
						<div class="col px-5 overflow-hidden">
							&boxur; <span class="font-weight-bold">{{event.type}}</span>: {{ event.data|safe }}
						</div>
					</div>
				</div>
			{% endfor %}
			
		</div>
	</div>
	
	<div class="modal fade" id="report1CModal" tabindex="-1" role="dialog" aria-labelledby="report1CModalLabel" aria-hidden="true">
		<div class="modal-dialog" role="document">
			<div class="modal-content">
				<div class="modal-header">
					<h5 class="modal-title" id="report1CModalLabel">Экспорт в 1С</h5>
					<button type="button" class="close" data-dismiss="modal" aria-label="Close">
						<span aria-hidden="true">&times;</span>
					</button>
				</div>
				<form method="POST" action="{{ url_for('main.Get1CReport', order_id = order['orderNumber']) }}">
					<div class="modal-body">
						<h6>Заявка #{{ order['vendorOrderNumber'] }} от {{ moment(order['createDate']).format() }}</h6>
						<h6>Площадка {{ order['refererId'] }}</h6>
						{{ export1C_form.csrf_token }}
						<div class="form-group">
							{{ export1C_form.date.label }}
							{{ export1C_form.date(class_ = 'form-control') }}
						</div>
						<div class="form-check">
							{{ export1C_form.send_email(class_ = 'form-check-input') }}
							{{ export1C_form.send_email.label(class_='form-check-label') }}
						</div>
						<div class="form-text text-info">
							{%if order['orderComments']['object']|length == 0%}
								<span class="text-danger">Объект не указан.</span>
							{%endif%}
							{%if order['orderComments']['object']|length == 0%}
								<span class="text-danger">Статья БДР не указана.</span>
							{%endif%}
							{%if order['orderComments']['object']|length == 0%}
								<span class="text-danger">Статья БДДС не указана.</span>
							{%endif%}
							{%if order['has_units'] is sameas false %}
								<span class="text-danger">ЕИ не указаны.</span>
							{%endif%}
						</div>
						<div class="form-text text-info d-none" id="exportNotification">
							Файл сохранён в папку загрузки и отправлен, если это было указано.
						</div>
					</div>
					<div class="modal-footer">
						{{ export1C_form.submit(class_ = 'btn btn-primary', id="exportSubmit") }}
						<button type="button" class="btn btn-secondary" data-dismiss="modal">Закрыть</button>
					</div>
				</form>
			</div>
		</div>
	</div>

	<div class="modal fade" id="BECModal" tabindex="-1" role="dialog" aria-labelledby="BECModalLabel" aria-hidden="true">
		<div class="modal-dialog" role="document">
			<div class="modal-content">
				<div class="modal-header">
					<h5 class="modal-title" id="BECModalLabel">Статья БДР</h5>
					<button type="button" class="close" data-dismiss="modal" aria-label="Close">
						<span aria-hidden="true">&times;</span>
					</button>
				</div>
				<form method="POST" action="{{ url_for('main.SaveBEC', order_id = order['orderNumber']) }}">
					<div class="modal-body">
						{{ bec_form.csrf_token }}
						<div class="form-group">
							{{ bec_form.bec.label }}
							{{ bec_form.bec(class_ = 'form-control', placeholder='Введите статью БДР...') }}
						</div>
					</div>
					<div class="modal-footer">
						{{ bec_form.submit(class_ = 'btn btn-primary') }}
						<button type="button" class="btn btn-secondary" data-dismiss="modal">Закрыть</button>
					</div>
				</form>
			</div>
		</div>
	</div>
	
	<div class="modal fade" id="CFSModal" tabindex="-1" role="dialog" aria-labelledby="CFSModalLabel" aria-hidden="true">
		<div class="modal-dialog" role="document">
			<div class="modal-content">
				<div class="modal-header">
					<h5 class="modal-title" id="BECModalLabel">Статья БДДС</h5>
					<button type="button" class="close" data-dismiss="modal" aria-label="Close">
						<span aria-hidden="true">&times;</span>
					</button>
				</div>
				<form method="POST" action="{{ url_for('main.SaveCFS', order_id = order['orderNumber']) }}">
					<div class="modal-body">
						{{ cfs_form.csrf_token }}
						<div class="form-group">
							{{ cfs_form.cfs.label }}
							{{ cfs_form.cfs(class_ = 'form-control', placeholder='Введите статью БДДС...') }}
						</div>
					</div>
					<div class="modal-footer">
						{{ cfs_form.submit(class_ = 'btn btn-primary') }}
						<button type="button" class="btn btn-secondary" data-dismiss="modal">Закрыть</button>
					</div>
				</form>
			</div>
		</div>
	</div>	
	
	<div class="modal fade" id="SiteModal" tabindex="-1" role="dialog" aria-labelledby="SiteModalLabel" aria-hidden="true">
		<div class="modal-dialog" role="document">
			<div class="modal-content">
				<div class="modal-header">
					<h5 class="modal-title" id="SiteModalLabel">Объект</h5>
					<button type="button" class="close" data-dismiss="modal" aria-label="Close">
						<span aria-hidden="true">&times;</span>
					</button>
				</div>
				<form method="POST" action="{{ url_for('main.SaveSite', order_id = order['orderNumber']) }}">
					<div class="modal-body">
						{{ site_form.csrf_token }}
						<div class="form-group">
							{{ site_form.object.label }}
							{{ site_form.object(class_ = 'form-control', list='sitesList', placeholder='Введите название объекта...') }}
							{% if order['location'] %}
								<datalist id="sitesList">
								{% for site in order['location']['sites']%}
									<option>{{ site.name }}</option>
								{% endfor %}
								</datalist>
							{% endif %}
						</div>
					</div>
					<div class="modal-footer">
						{{ site_form.submit(class_ = 'btn btn-primary') }}
						<button type="button" class="btn btn-secondary" data-dismiss="modal">Закрыть</button>
					</div>
				</form>
			</div>
		</div>
	</div>

{% endblock %}

{% block scripts %}

<script>	
	$(document).ready(function(){
	
		$("#actionsSection").find(".action").sort(function(a, b){return +$(b).data("datetime") - +$(a).data("datetime")}).appendTo("#actionsSection");
	
		$("#actionsFilter").on("keyup", function() {
			var value = $(this).val().toLowerCase();
			$(".action").filter(function() {
				$(this).toggle($(this).text().toLowerCase().indexOf(value) > -1)
			});
		});
		
		$(".product-sku").click(
		   function(){ var val= '#'+$(this).text(); $(val).addClass("alert-warning") },
		);
		
		$("#commentFormCollapse").on("shown.bs.collapse", function() {
		  this.scrollIntoView();
		});
		
		$("#exportSubmit").click(function(){
			setTimeout(() => $("#exportNotification").removeClass("d-none"), 1000);
		});
		
		{% if current_user.role.name == 'initiative' %}
			var oldQuantity = 0;
			$('.productQuantity').focus(function() {
				$(this).removeClass('form-control-plaintext');
				$(this).addClass ('form-control');
				oldQuantity = $(this).val();
			});
			$('.productQuantity').focusout(function() {
				if ($(this).val() != oldQuantity){
					var agreed = true;
					if ($(this).val() == 0){
						if ($(".ecwidOrderProduct").length == 1){
							agreed = window.confirm("Заявка будет удалена.");
						} else {
							agreed = window.confirm("Товар будет удален.");
						}
					}
					if (agreed == true){
						$(this).closest("form").submit();
					} else {
						alert("Заявка не будет изменена.");
						$(this).val(oldQuantity);
					}
				}
				$(this).removeClass ('form-control');
				$(this).addClass('form-control-plaintext');
			});
			$('#location_name').change(function(){
				$(this).closest("form").submit();
			});
		{% endif %}
	});
</script>
{%endblock %}