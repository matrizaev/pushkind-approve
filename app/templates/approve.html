{% extends "base.html" %}

{% block content %}
	<div class="container border bg-light my-1">
		<h6 class="border-bottom border-gray pb-2 mb-0">Заявка</h6>
			<div class="row">
				<div class="col text-right">
					<a class="btn btn-success btn-sm my-1" href="{{ url_for('main.GetExcelReport', order_id = order['orderNumber']) }}">Excel-отчёт</a>
					{% if current_user.role.name == 'initiative' %}
						<a class="btn btn-warning btn-sm my-1" href="{{ url_for('main.DuplicateOrder', order_id = order['orderNumber']) }}" onclick="return confirm('Клонировать заявку?')">Клонировать</a>
						<a class="btn btn-warning btn-sm my-1" href="{{ url_for('main.NotifyApprovers', order_id = order['orderNumber']) }}" onclick="return confirm('Отправить уведомление согласующим?')">Уведомить</a>
					{% elif current_user.role.name == 'approver' %}
						<a class="btn btn-info btn-sm my-1" href="{{ url_for('main.ProcessHubOrder', order_id = order['orderNumber']) }}" {% if order['externalFulfillment'] %}onclick="return confirm('Уже отправлена, отправить ещё раз?')"{% endif %}>Отправить</a>
					{% endif %}
				</div>
			</div>		
		<div class="row my-1 d-none d-sm-flex font-weight-bold  px-3">
			<div class="col overflow-hidden">
				Номер
			</div>
			<div class="col overflow-hidden">
				Дата
			</div>
			<div class="col overflow-hidden">
				Инициатор
			</div>
			<div class="col overflow-hidden">
				Сумма
			</div>
			<div class="col overflow-hidden">
				Статус
			</div>
			{% if current_user.role.name in ['validator','approver'] %}
				<div class="col overflow-hidden">
					Согласование
				</div>
			{% endif %}
		</div>
		{% include '_order.html' %}
	</div>

	<div class="container border bg-light my-1">
		<h6 class="border-bottom border-gray pb-2 mb-0">Товары</h6>
		<div class="row my-1 d-none d-sm-flex font-weight-bold px-3">
			<div class="col overflow-hidden">
				Изображение
			</div>		
			<div class="col overflow-hidden">
				Артикул
			</div>		
			<div class="col overflow-hidden">
				Название
			</div>		
			<div class="col overflow-hidden">
				Поставщик
			</div>
			<div class="col overflow-hidden">
				Единицы
			</div>
			<div class="col overflow-hidden">
				Цена
			</div>
			<div class="col overflow-hidden">
				Количество
			</div>
			{% if current_user.role.name in ['validator','approver'] %}
				<div class="col">
					Отклонение
				</div>
			{% endif %}
		</div>
		{% for product in order['items'] %}
			{% include '_product.html' %}
		{% endfor %}
	</div>
	
	{% if current_user.role.name not in ['admin','default'] %}
		<div class="container border bg-light my-1">
			<div class="row">
				<div class="col text-right">
					<button class="btn btn-link" type="button" data-toggle="collapse" data-target="#commentFormCollapse" aria-expanded="false" aria-controls="commentFormCollapse">
						Редактировать комментарий
					</button>
				</div>
			</div>
			<div class="collapse" id="commentFormCollapse">
				{% set errorsList = comment_form.comment.errors %}
				{% if errorsList|length > 0 %}
					<div class = "row">
						<div class="col">
							<div class="alert alert-danger" role="alert">
								{% for error in  errorsList %}
									{{ error }}<br>
								{% endfor %}
							</div>
						</div>
					</div>
				{% endif %}
				<form action="{{ url_for('main.SaveComment', order_id = order['orderNumber']) }}" method="post" id="changeCommentForm">
					{{ comment_form.csrf_token }}
					<div class="form-group row">
						{{ comment_form.comment.label(class_ = "col-md-2 col-form-label") }}
						<div class="col-md-10">
							{{ comment_form.comment(class_ = 'form-control') }}
						</div>
					</div>
					<div class="form-group row">
						<div class="col">
							{{ comment_form.submit(class_ = 'btn btn-primary') }}
						</div>
					</div>
				</form>
			</div>
		</div>
	{% endif %}
	<div class="container border bg-light my-1">
		<h6 class="border-bottom border-gray pb-2 mb-0">История</h6>
		<div class="row my-1">
			<div class="col">
				<input class="form-control" id="actionsFilter" type="text" placeholder="Фильтр..">
			</div>
		</div>
		<div id="actionsSection">
			{% if order['externalFulfillment'] %}
				<div class="action row my-1 alert-info" data-datetime="{{ order['privateAdminNotes'].timestamp() }}">
					<div class="col-1">
						<img class=" my-2 bg-info rounded-circle" style="width:32px;height:32px" src="https://approvals.pushkind.com/static/octicons/mail.svg" alt="Отправлена">
					</div>
					<div class="col-3">
						<h6 class="mt-0">
							Отправлена поставщикам<br>
							<sup class="small">
								{{ moment(order['privateAdminNotes']).format() }}
							</sup>
						</h6>
					</div>
					<div class="col">
						Номера заявок у поставщиков - <strong>{{ order['externalOrderId'] }}</strong>
					</div>
				</div>
			{% endif %}
			{% for approval in approvals %}
				{% if approval.product_id %}
				<div class="action row my-1 alert-danger" data-datetime="{{ approval.timestamp.timestamp() }}">
					<div class="col-1">
						<img class=" my-2 bg-danger rounded-circle" style="width:32px;height:32px" src="https://approvals.pushkind.com/static/octicons/x.svg" alt="Отклонен">
				{% else %}
				<div class="action row my-1 alert-success" data-datetime="{{ approval.timestamp.timestamp() }}">
					<div class="col-1">
						<img class=" my-2 bg-success rounded-circle" style="width:32px;height:32px" src="https://approvals.pushkind.com/static/octicons/check.svg" alt="Согласована">
				{% endif %}
					</div>
					<div class="col-3">
						<h6 class="mt-0">
							{% if approval.user.name %}
								{{ approval.user.name }}
							{% else %}
								{{ approval.user.email }}
							{% endif %}
							<br>
							<sup class="small">
								{{ moment(approval.timestamp).format() }}
							</sup>
						</h6>
					</div>
					<div class="col">
						{% if approval.product_id %}
							Товар <strong>{{ approval.product_sku }}</strong> отклонён.
						{% else %}
							Заявка одобрена.
						{% endif %}
					</div>
				</div>
			{% endfor %}
			{% for comment in comments %}			
				<div class="action row my-1 alert-warning" data-datetime="{{ comment.timestamp.timestamp() }}" id="comment{{comment.user_id}}">
					<div class="col-1">
						<img class="align-self-center mr-3 bg-warning rounded-circle" style="width:32px;height:32px" src="https://approvals.pushkind.com/static/octicons/pencil.svg" alt="Комментарий">
					</div>
					<div class="col-3">
						<h6 class="mt-0">
							{% if comment.user.name %}
								{{ comment.user.name }}
							{% else %}
								{{ comment.user.email }}
							{% endif %}
							<br>
							<sup class="small">
								{{ moment(comment.timestamp).format() }}
							</sup>
						</h6>
					</div>
					<div class="col commentBody">
						{{ comment.comment }}
					</div>
				</div>
			{% endfor %}
		</div>
	</div>
{% endblock %}

{% block templates %}
	<div class="action row my-1 alert-warning" id="commentTemplate">
		<div class="col-1">
			<img class="align-self-center mr-3 bg-warning rounded-circle" style="width:32px;height:32px" src="https://approvals.pushkind.com/static/octicons/pencil.svg" alt="Комментарий">
		</div>
		<div class="col-3">
			<h6 class="mt-0">
			</h6>
		</div>
		<div class="col commentBody">
		</div>
	</div>
{% endblock %}

{% block scripts %}

<script>	
	$(document).ready(function(){
	
		$("#actionsFilter").on("keyup", function() {
			var value = $(this).val().toLowerCase();
			$(".action").filter(function() {
				$(this).toggle($(this).text().toLowerCase().indexOf(value) > -1)
			});
		});
	
		$("#actionsSection").find(".action").sort(function(a, b){return +$(b).data('datetime') - +$(a).data('datetime')}).appendTo('#actionsSection');
		
		{% if current_user.role.name == 'initiative' %}
			function UpdateOrderTotal(data){
				if (data.status == true){
					if (data.quantity == 0){
						if ($(".ecwidOrderProduct").length == 1){
							alert("Заявка удалена, вы будете перенаправлены на главную страницу.");
							setTimeout(function(){
								document.location.href = "{{ url_for('main.ShowIndex') }}";
							}, 2000);
						}else
							document.location.reload();
					}
					$(".orderTotal").text(data.total);
				}
				ShowAjaxFlashes(data);
			}
			
			var oldQuantity = 0;
			$('.productQuantity').focus(function() {
				$(this).removeClass('form-control-plaintext');
				$(this).addClass ('form-control');
				oldQuantity = $(this).val();
			});
			$('.productQuantity').focusout(function() {
				if ($(this).val() != oldQuantity){
					var agreed = true;
					if ($(this).val() == 0){
						if ($(".ecwidOrderProduct").length == 1){
							agreed = window.confirm("Заявка будет удалена.");
						} else {
							agreed = window.confirm("Товар будет удален.");
						}
					}
					if (agreed == true){
						$(this).parent().submit();
					} else {
						alert("Заявка не будет изменена.");
						$(this).val(oldQuantity);
					}
				}
				$(this).removeClass ('form-control');
				$(this).addClass('form-control-plaintext');
			});
		{% endif %}
		{% if current_user.role.name not in ['default','admin'] %}
			function UpdateOrderComment(data){
				if (data.status == true){
					var authorComment = $("#comment{{ current_user.id }}");
					var actionsSection = $("#actionsSection");
					if (data.comment.length > 0){
						if (authorComment.length == 0){
							authorComment = $("#commentTemplate").clone();
							authorComment.attr("id", "comment{{ current_user.id }}");
						}
						var timestamp = new Date(data.timestamp);
						var author = authorComment.find("h6");
						{% if current_user.name %}
							author.text("{{ current_user.name }}");
						{% else %}
							author.text("{{ current_user.email }}");
						{% endif %}
						author.append('<br>');
						author.append('<sup class="small">' + moment(timestamp).format("DD.MM.YYYY HH:mm") + '</sup>');
						actionsSection.prepend(authorComment);
						var comment = authorComment.find(".commentBody");
						comment.text(data.comment);
					}else{
						if (authorComment.length != 0)
							authorComment.remove();
					}
					$("#commentFormCollapse").collapse('hide');
				}
				ShowAjaxFlashes(data);
			}
			var options = {
				success:	UpdateOrderComment,
				url: "{{ url_for('main.SaveComment', order_id = order['orderNumber']) }}",
				dataType:	'json',
				method: 'POST',
				clearForm: false
			};
			$('#changeCommentForm').ajaxForm(options);
			$('#comment').focusout(function() {
				$(this).parent().submit();
			});
		{% endif %}
	});
</script>
{%endblock %}