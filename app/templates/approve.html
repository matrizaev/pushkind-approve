{% extends "base.html" %}

{% block content %}
	<div class="container border bg-light my-1">
		<h6 class="text-secondary">Заявка</h6>
		{% if current_user.role.name == 'initiative' %}
			<div class="row">
				<div class="col text-right">
					<a class="btn btn-danger btn-sm" href="{{ url_for('main.DeleteOrder', order_id = order['orderNumber']) }}" onclick="return confirm('Удалить заявку?')">Удалить</a>
				</div>
			</div>
		{% elif current_user.role.name == 'approver' %}
			<div class="row">
				<div class="col text-right">
					<a href="{{ url_for('main.ProcessHubOrder', order_id = order['orderNumber']) }}" class="btn btn-success btn-sm">Отправить</a>
				</div>
			</div>
		{% endif %}
		<div class="row my-1 d-none d-sm-flex font-weight-bold">
			<div class="col overflow-hidden">
				Номер
			</div>
			<div class="col overflow-hidden">
				Дата
			</div>
			<div class="col overflow-hidden">
				Инициатор
			</div>
			<div class="col overflow-hidden">
				Сумма
			</div>
			<div class="col overflow-hidden">
				Согласование
			</div>
		</div>
		{% include '_order.html' %}
	</div>

	<div class="container border bg-light my-1">
		<h6 class="text-secondary">Товары</h6>
		<div class="row my-1 d-none d-sm-flex font-weight-bold">
			<div class="col overflow-hidden">
				Название
			</div>
			<div class="col overflow-hidden">
				Артикул
			</div>
			<div class="col overflow-hidden">
				Цена
			</div>
			<div class="col overflow-hidden">
				Количество
			</div>
			<div class="col overflow-hidden">
				Единицы
			</div>
			<div class="col overflow-hidden">
				Изображение
			</div>
			{% if current_user.role.name in ['validator','approver'] %}
				<div class="col">
					Отклонить
				</div>
			{% endif %}
		</div>
		{% for product in order['items'] %}
			{% include '_product.html' %}
		{% endfor %}
	</div>
	
	{% if current_user.role.name in ['validator','approver','initiative'] %}
		<div class="container border bg-light my-1">
			<div class="row">
				<div class="col text-right">
					<button class="btn btn-link" type="button" data-toggle="collapse" data-target="#commentFormCollapse" aria-expanded="false" aria-controls="commentFormCollapse">
						Редактировать комментарий
					</button>
				</div>
			</div>
			<div class="collapse" id="commentFormCollapse">
				{% set errorsList = comment_form.comment.errors %}
				{% if errorsList|length > 0 %}
					<div class = "row">
						<div class="col">
							<div class="alert alert-danger" role="alert">
								{% for error in  errorsList %}
									{{ error }}<br>
								{% endfor %}
							</div>
						</div>
					</div>
				{% endif %}
				<form action="{{ url_for('main.SaveComment', order_id = order['orderNumber']) }}" method="post" id="changeCommentForm">
					{{ comment_form.csrf_token }}
					<div class="form-group row">
						{{ comment_form.comment.label(class_ = "col-md-2 col-form-label") }}
						<div class="col-md-10">
							{{ comment_form.comment(class_ = 'form-control') }}
						</div>
					</div>
					<div class="form-group row">
						<div class="col">
							{{ comment_form.submit(class_ = 'btn btn-primary') }}
						</div>
					</div>
				</form>
			</div>
		</div>
	{% endif %}
	
	{% if approvals|length > 0 or comments|length > 0 %}
		<div class="container my-1">
			<div class="card-columns" id="commentsSection">
				{% for approval in approvals %}
					<div class="card text-white {% if approval.product_id %}bg-danger{% else %}bg-success{% endif %}">
						<div class="card-body">
							<p>
							{% if approval.product_id %}
								Товар {{ approval.product_sku }} отклонён.
							{% else %}
								Заявка одобрена.
							{% endif %}
							</p>
						</div>
						<div class="card-footer font-weight-bold">
							{% if approval.user.name %}
								{{ approval.user.name }}
							{% else %}
								{{ approval.user.email }}
							{% endif %}
						</div>
					</div>
				{% endfor %}
				{% for comment in comments %}
					<div class="card text-white bg-warning" id="{{'comment{}'.format(comment.user.id)}}">
						<div class="card-body">
							<p>
								{{ comment.comment }}
							</p>
						</div>
						<div class="card-footer font-weight-bold">
							{% if comment.user.name %}
								{{ comment.user.name }}
							{% else %}
								{{ comment.user.email }}
							{% endif %}
						</div>
					</div>
				{% endfor %}
			</div>
		</div>
		
	{% else %}
		<div class="container my-1 d-none">
			<div class="card-columns" id="commentsSection">
			</div>
		</div>
	{% endif %}

{% endblock %}

{% block templates %}
	<div class="card text-white bg-warning" id="commentTemplate">
		<div class="card-body">
			<p>
			</p>
		</div>
		<div class="card-footer font-weight-bold">
		</div>
	</div>
{% endblock %}

{% block scripts %}

<script>
	function UpdateOrderTotal(data){
		if (data.status == true){
			$("#orderTotal").text(data.total);
		}
		ShowAjaxFlashes(data);
	}
	function UpdateOrderComment(data){
		if (data.status == true){
			var authorComment = $("{{ '#comment{}'.format(current_user.id) }}");
			var commentsSection = $("#commentsSection");
			if (data.comment.length > 0){
				commentsSection.parent().removeClass('d-none');
				if (authorComment.length == 0){
					authorComment = $("#commentTemplate").clone();
					authorComment.attr("id", "{{'comment{}'.format(current_user.id)}}");
					var author = authorComment.find('.card-footer');
					{% if current_user.name %}
						author.text("{{ current_user.name }}");
					{% else %}
						author.text("{{ current_user.email }}");
					{% endif %}
					commentsSection.append(authorComment);
				}
				var comment = authorComment.find(".card-body p");
				comment.text(data.comment);
			}else{
				authorComment.remove();
				if (commentsSection.find(".card").length == 0)
					commentsSection.parent().addClass("d-none");
			}
		}else
			ShowAjaxFlashes(data);
	}	
	$(document).ready(function(){
		//Scripts
		var options = {
			success:	UpdateOrderTotal,
			url: "{{ url_for('main.SaveQuantity', order_id = order['orderNumber']) }}",
			dataType:	'json',
			method: 'POST',
			clearForm: false
		};
		$('.changeQuantityForm').ajaxForm(options);
		$('.productQuantity').focus(function() {
			$(this).removeClass('form-control-plaintext');
			$(this).addClass ('form-control')
		});
		$('.productQuantity').focusout(function() {
			$(this).parent().submit();
			$(this).removeClass('form-control');
			$(this).addClass ('form-control-plaintext')
		});
		var options = {
			success:	UpdateOrderComment,
			url: "{{ url_for('main.SaveComment', order_id = order['orderNumber']) }}",
			dataType:	'json',
			method: 'POST',
			clearForm: false
		};
		$('#changeCommentForm').ajaxForm(options);
		$('#comment').focusout(function() {
			$(this).parent().submit();
		});
	});
</script>
{%endblock %}