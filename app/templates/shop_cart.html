{% extends "base.html" %}

{% block styles%}

{% endblock %}

{% block content %}

<div class="container bg-white border rounded">

    <div class="row">
        <div class="col overflow-hidden">
            Создание заявки для:<br>
            <a class="text-muted text-decoration-none" href="{{url_for('main.ShopCategories')}}" id="siteProjectSelect">Выбор проекта и объекта</a>
        </div>
        <div class="col-auto text-end overflow-hidden">
            <a class="text-muted" href="{{url_for('main.ShopCart')}}">
                <i class="bi bi-cart fs-4"></i><br>
                <small class="text-muted" id="inCartItems"></small>
            </a>
        </div>
    </div>

    <nav aria-label="breadcrumb">
        <ol class="breadcrumb">
            <li class="breadcrumb-item">
                <a href="{{url_for('main.ShopCategories')}}">Категории</a>
            </li>
            <li class="breadcrumb-item active" aria-current="page">Корзина</li>
        </ol>
    </nav>

    <form method="POST" action="{{url_for('main.ShopCart')}}" id="shoppingCartForm">
        {{ form.csrf_token }}
        {{ form.project_id(class_='d-none') }}
        {{ form.site_id(class_='d-none') }}
        <div class="alert alert-secondary my-1" id="emptyCartAlert">
            Корзина пуста
        </div>
        <div id="shoppingCartItems">
        </div>
        <div class="row my-3">
            <div class="col">
                {{ form.submit(class_='btn btn-primary text-white d-none') }}
            </div>
        </div>
    </form>

</div>

{% endblock %}

{% block templates %}
<div class="row rounded border-top border-bottom my-1 py-1 cartItem" id="cartItemTemplate">
    <div class="col-auto">
        <input required type="number" class="d-none" name="cart-_-product" hidden id="productIdTemplate">
        <img id="productImageTemplate" src="{{ config['PLACEHOLDER_IMAGE'] }}" height="64" width="64" alt="thumbnail">
    </div>
    <div class="col overflow-hidden">
        <h5 id="productNameTemplate"></h5>
        <small>Артикул: <span id="productSkuTemplate"></span></small>
    </div>
    <div class="col-sm-1 overflow-hidden">
        <span id="productVendorTemplate"></span>
    </div>
    <div class="col-sm-2 overflow-hidden">
        Цена: <strong id="productPriceTemplate"></strong>
        <br>
        Единицы: <strong id="productMeasurementTemplate"></strong>
        <br>
        <div class="input-group my-1">
            <span class="input-group-text">Кол-во</span>
            <input required type="number" value="1" min="1" step="1" class="form-control addToCart" name="cart-_-quantity" id="productQuantityTemplate">
        </div>
        <button class="btn btn-danger removeFromCart mb-1" id="productRemoveTemplate">
            Удалить
        </button>
    </div>
    <div class="col-sm-3 overflow-hidden">
        <textarea style="height: 100%;" class="form-control addToCart" name="cart-_-text" id="productTextTemplate" rows="3" placeholder="Комментарий, ссылка на файл в облаке или текст баннера"></textarea>
    </div>
</div>
{% endblock %}

{% block scripts %}
<script>
    $(document).ready(function () {

        var shoppingCart = sessionStorage.getItem('shoppingCart');

        function SetInCartText(){
            let numItems = shoppingCart.length;
            if (numItems > 0){
                let totalPrice = shoppingCart.reduce((a, b) => a + (b['price']|| 0) * (b["quantity"] || 0), 0);
                $("#inCartItems").text(numItems + ' позиции на сумму ' + totalPrice.toFixed(2));
            }
            else
                $("#inCartItems").text('');
        }

        var shoppingCartItems = $("#shoppingCartItems");
        if (!shoppingCart){
            shoppingCart = [];
            sessionStorage.setItem('shoppingCart', JSON.stringify(shoppingCart));
        }
        else {

            try {
                shoppingCart = JSON.parse(shoppingCart);
            } catch(e) {
                shoppingCart = [];
                sessionStorage.setItem('shoppingCart', JSON.stringify(shoppingCart));
            }
        }
        SetInCartText();

        let project_id = Number(sessionStorage.getItem('project_id'));
        let site_id = Number(sessionStorage.getItem('site_id'));
        let site_name = sessionStorage.getItem('site_name');
        let project_name = sessionStorage.getItem('project_name');
        if (!project_id || !site_id || !project_name || !site_name)
            window.location = "{{url_for('main.ShopCategories')}}";
        $("#siteProjectSelect").text(project_name + ', ' + site_name);

        $("#project_id").val(project_id);
        $("#site_id").val(site_id);

        $("#siteProjectSelect").click(function(){
            sessionStorage.removeItem("project_id");
            sessionStorage.removeItem("project_name");
            sessionStorage.removeItem("site_id");
            sessionStorage.removeItem("site_name");
        });

        if (shoppingCart.length > 0){
            $("#submit").removeClass('d-none');
            $("#emptyCartAlert").addClass("d-none");
        }

        let i = 0;
        shoppingCart.forEach(item => {
            let content = $('#cartItemTemplate').clone();
            let sku = content.find('#productSkuTemplate');
            let name = content.find('#productNameTemplate');
            let text = content.find('#productTextTemplate');
            let image = content.find('#productImageTemplate');
            let vendor = content.find('#productVendorTemplate');
            let price = content.find('#productPriceTemplate');
            let remove = content.find('#productRemoveTemplate');
            let product = content.find('#productIdTemplate');
            let quantity = content.find('#productQuantityTemplate');
            let measurement = content.find('#productMeasurementTemplate');

            content.removeAttr('id');
            sku.removeAttr('id');
            name.removeAttr('id');
            text.removeAttr('id');
            image.removeAttr('id');
            vendor.removeAttr('id');
            price.removeAttr('id');
            remove.removeAttr('id');
            product.removeAttr('id');
            quantity.removeAttr('id');
            measurement.removeAttr('id');

            content.data('id', item['id']);
            sku.text(item['sku']);
            name.text(item['name']);
            text.val(item['text']);
            if (item['image'])
                image.attr('src', item['image']);
            vendor.text(item['vendor']);
            price.text(item['price'].toFixed(2));
            product.val(item['id']);
            quantity.val(item['quantity']);
            measurement.text(item['measurement']);
            remove.data('id', item['id']);

            text.attr('name', text.attr('name').replace('_', i));
            product.attr('name', product.attr('name').replace('_', i));
            quantity.attr('name', quantity.attr('name').replace('_', i));

            shoppingCartItems.append(content);
            i++;
        });

        $(".removeFromCart").click(function(){
            let itemId = Number($(this).data('id'));
            shoppingCart = shoppingCart.filter(obj => {return obj['id'] !== itemId});
            sessionStorage.setItem('shoppingCart', JSON.stringify(shoppingCart));
            $(this).parent('.cartItem').remove();
            if (shoppingCartItems.children.length == 0){
                $("#submit").addClass('d-none');
                $("#emptyCartAlert").removeClass("d-none");
            }
            SetInCartText();
        });
        $("#submit").click(function(){
            shoppingCart = [];
            sessionStorage.setItem('shoppingCart', JSON.stringify(shoppingCart));
        });
        $(".addToCart").on("keyup change", function(){
            let form = $(this).closest('.cartItem');
            let timerId = form.data('timer');
            if (timerId)
                clearTimeout(timerId);
            timerId = setTimeout(function(form){
                form.removeData('timer');
                let itemId = Number(form.data('id'));
                let itemQuantity = Number(form.find('input.addToCart').val());
                let itemText = form.find('textarea.addToCart').val();
                if (!itemQuantity || itemQuantity == 0){
                    itemQuantity = 1;
                    input.val(itemQuantity);
                }
                let cartItem = shoppingCart.find(obj => {return obj['id'] === itemId});
                if (cartItem){
                    cartItem["text"] = itemText;
                    cartItem["quantity"] = itemQuantity;
                }
                sessionStorage.setItem('shoppingCart', JSON.stringify(shoppingCart));
                SetInCartText();
            }, 500, form);
            form.data('timer', timerId);
        });
    });

</script>
{%endblock %}